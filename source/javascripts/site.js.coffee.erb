#= require jquery.lazyload
#= require jquery-smooth-scroll/jquery.smooth-scroll
#= require js-cookie
#= require autosize
#= require bootstrap/collapse
#= require bootstrap/tooltip
#= require bootstrap/dropdown

origin = window.location.protocol + '//' + window.location.host
if origin != "<%= host %>"
  correctUrl = window.location.href.replace(origin, "<%= host %>")
  window.location.replace correctUrl

$ ->
  $('a[href^="#"]').smoothScroll()
  $('img.lazy').show().lazyload(effect: 'fadeIn')
  $('[data-toggle="tooltip"]').tooltip()
  autosize(document.querySelectorAll('.autosize'))
  showCookieBar()
  submitFormsViaAjax()

showCookieBar = ->
  unless Cookies.get('cookie-consent')?
    cookieBar = $('#cookie-bar')
    cookieBar
      .slideDown()
      .find('a')
      .click (e) ->
        e.preventDefault()
        Cookies.set 'cookie-consent', 'true',
          expires: 365
          path:    '/'
        cookieBar.slideUp()

submitFormsViaAjax = ->
  $('form').submit (e) ->
    e.preventDefault()

    $submit = $(@).find(':submit')
    $submit.data('original-text', $submit.text())
    $submit.text($submit.data('loading'))
    $submit.addClass('disabled')

    $.ajax @action,
      type:     'POST'
      data:     $(@).serialize()
      dataType: 'json'
    .always =>
      $submit.removeClass('disabled')
      $submit.text($submit.data('original-text'))
    .done =>
      $(@)
        .slideUp()
        .siblings('.note.note-confirm')
        .slideDown()
    .fail (xhr, status) =>
      if Rollbar?
        Rollbar.error 'Error submitting form.', xhr: xhr, status: status
      $(@)
        .siblings('.note.note-error')
        .slideDown()
